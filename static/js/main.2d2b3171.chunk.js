(window["webpackJsonpvkminiapp.loc"]=window["webpackJsonpvkminiapp.loc"]||[]).push([[0],{161:function(e,t,n){e.exports=n(256)},245:function(e,t,n){},256:function(e,t,n){"use strict";n.r(t);n(162),n(188),n(190),n(191),n(193),n(194),n(195),n(196),n(197),n(198),n(199),n(200),n(202),n(203),n(204),n(205),n(206),n(207),n(208),n(209),n(210),n(211),n(213),n(214),n(215),n(216),n(217),n(218),n(219),n(220),n(221),n(222),n(223),n(224),n(225),n(226),n(227),n(228),n(229),n(230);var a=n(0),r=n.n(a),s=n(32),c=n.n(s),i=n(20),o=n.n(i),u=n(6),l=n.n(u),p=n(58),h=n(7),f=(n(244),n(36)),m=n(37),d=n(39),b=n(38),k=n(40),v=n(21);function y(e,t,n){return new Promise((function(a,r){var s=new XMLHttpRequest;s.open(e,t,!0),s.onload=function(){if(200===this.status)a(this.response);else{var e=new Error(this.statusText);e.code=this.status,r(e)}},s.onerror=function(){r("Network Error")},n&&"string"!==typeof n&&(n=JSON.stringify(n)),s.send(n)}))}function g(e,t,n){var a,r;return l.a.async((function(s){for(;;)switch(s.prev=s.next){case 0:return s.next=2,l.a.awrap(y(e,t,n));case 2:return a=s.sent,s.prev=3,r=JSON.parse(a),s.abrupt("return",r);case 8:return s.prev=8,s.t0=s.catch(3),console.warn("".concat(e," '").concat(t,"' -> returns non-json response. Error:"),s.t0),s.abrupt("return",!1);case 12:case"end":return s.stop()}}),null,null,[[3,8]])}var x="https://vkapp.mailpromtrans.ru/api/",E=null,w=null;function O(e,t){return g("GET",x+e,t)}function j(e,t){return g("POST",x+e,t)}function P(e){var t;return l.a.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,l.a.awrap(O(e));case 2:if(!1!==(t=n.sent)){n.next=5;break}return n.abrupt("return",[]);case 5:if(!("players"===e&&"players"in t)){n.next=10;break}return E=t.players,n.abrupt("return",E);case 10:if(!("game"===e&&"players"in t)){n.next=15;break}return w=t.players,n.abrupt("return",w);case 15:console.warn("Cannot find {response}.players from request to '".concat(e,"' API"));case 16:case"end":return n.stop()}}))}function U(){return P("players")}function _(){return P("game")}var C={getPlayer:function(e){return l.a.async((function(t){for(;;)switch(t.prev=t.next){case 0:if(E&&E[e]){t.next=3;break}return t.next=3,l.a.awrap(U());case 3:if(!(e in E)){t.next=5;break}return t.abrupt("return",E[e]);case 5:return t.abrupt("return",!1);case 6:case"end":return t.stop()}}))},getPlayerByNickname:function(e){var t;return l.a.async((function(n){for(;;)switch(n.prev=n.next){case 0:if(null!==E&&Object.keys(E).length){n.next=3;break}return n.next=3,l.a.awrap(U());case 3:n.t0=l.a.keys(E);case 4:if((n.t1=n.t0()).done){n.next=10;break}if(t=n.t1.value,E[t].nickname!==e){n.next=8;break}return n.abrupt("return",E[t]);case 8:n.next=4;break;case 10:return n.abrupt("return",!1);case 11:case"end":return n.stop()}}))},getPlayers:function(){return l.a.async((function(e){for(;;)switch(e.prev=e.next){case 0:if(!E){e.next=2;break}return e.abrupt("return",E);case 2:return e.next=4,l.a.awrap(U());case 4:return e.abrupt("return",E);case 5:case"end":return e.stop()}}))},isPlayerInGame:function(e){return l.a.async((function(t){for(;;)switch(t.prev=t.next){case 0:if(w){t.next=3;break}return t.next=3,l.a.awrap(_());case 3:return t.abrupt("return",e in w);case 4:case"end":return t.stop()}}))},getGamePlayers:function(){return l.a.async((function(e){for(;;)switch(e.prev=e.next){case 0:if(!w){e.next=2;break}return e.abrupt("return",w);case 2:return e.next=4,l.a.awrap(_());case 4:return e.abrupt("return",w);case 5:case"end":return e.stop()}}))},registerPlayer:function(e){var t;return l.a.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,l.a.awrap(j("register",{id:e}));case 2:if(!1!==(t=n.sent)&&!1!==t.ok){n.next=5;break}return n.abrupt("return",!1);case 5:return n.next=7,l.a.awrap(U());case 7:return n.abrupt("return",!0);case 8:case"end":return n.stop()}}))},addToGame:function(e){var t;return l.a.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,l.a.awrap(j("register",{id:e,signup_for_game:!0}));case 2:if(!1!==(t=n.sent)&&!1!==t.ok){n.next=5;break}return n.abrupt("return",!1);case 5:return n.next=7,l.a.awrap(U());case 7:return n.next=9,l.a.awrap(_());case 9:return n.abrupt("return",!0);case 10:case"end":return n.stop()}}))},setNickname:function(e,t){var n;return l.a.async((function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,l.a.awrap(j("players",{id:e,nickname:t}));case 2:if(!1!==(n=a.sent)&&!1!==n.ok){a.next=5;break}return a.abrupt("return",!1);case 5:return E[e]=Object.assign(E[e],n.players[e]),a.abrupt("return",!0);case 7:case"end":return a.stop()}}))},updatePlayer:function(e,t){var n,a;return l.a.async((function(r){for(;;)switch(r.prev=r.next){case 0:return n={id:e},t.name&&(n.name=t.name),t.nickname&&(n.nickname=t.nickname),t.sex&&(n.sex=t.sex),r.next=6,l.a.awrap(j("players",n));case 6:if(!1!==(a=r.sent)&&!1!==a.ok){r.next=9;break}return r.abrupt("return",!1);case 9:return E[e]=Object.assign(E[e],a.players[e]),r.abrupt("return",!0);case 11:case"end":return r.stop()}}))},updateMafia:function(){return l.a.async((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,l.a.awrap(U());case 2:return e.next=4,l.a.awrap(_());case 4:return e.abrupt("return",!0);case 5:case"end":return e.stop()}}))}},S=function(e){function t(e){var n;return Object(f.a)(this,t),(n=Object(d.a)(this,Object(b.a)(t).call(this,e))).state={title:"\u0418\u0433\u0440\u043e\u043a\u0438",view:r.a.createElement(h.e,null,r.a.createElement(h.q,{size:"large"})),fetching:!1},n.renderPlayers=n.renderPlayers.bind(Object(v.a)(n)),n.onRefresh=function(){n.setState({fetching:!0}),n.renderPlayers()},n}return Object(k.a)(t,e),Object(m.a)(t,[{key:"componentDidMount",value:function(){this.renderPlayers()}},{key:"componentDidUpdate",value:function(){this.renderPlayers()}},{key:"renderPlayers",value:function(){var e=this;C.getGamePlayers().then((function(t){return e.players=t,o.a.send("VKWebAppGetAuthToken",{app_id:7288259,scope:""})})).then((function(t){e.access_token=t.access_token;var n=[];for(var a in e.players)n.push(e.players[a].vk_id);return o.a.send("VKWebAppCallAPIMethod",{method:"users.get",params:{user_ids:n.join(","),fields:"photo_200",v:"5.103",access_token:e.access_token}})})).then((function(t){var n=t.response;for(var a in n){var s=n[a];e.players[s.id].photo_200=n[a].photo_200}var c=[],i=!1;if(e.players){var o=function(t){if(parseInt(t)===e.props.fetchedUser.id)return i=!0,delete e.players[t],"continue";c.push(r.a.createElement(h.d,{key:t,before:e.players[t].photo_200?r.a.createElement(h.b,{src:e.players[t].photo_200}):null,description:e.players[t].name,onClick:function(){window.open("https://vk.com/id"+t)}},e.players[t].nickname))};for(var u in e.players)o(u)}var l=Object.keys(e.players).length,p="\u0438\u0433\u0440\u043e\u043a";l<=4&&l>=2?p+="a":1!==l&&(p+="\u043e\u0432"),e.setState({title:(i?"\u0412\u044b \u0438 \u0435\u0449\u0451 ":"")+l+" "+p,view:c,fetching:!1})}))}},{key:"render",value:function(){return r.a.createElement(h.n,{onRefresh:this.onRefresh,isFetching:this.state.fetching},r.a.createElement(h.h,{title:this.state.title},this.state.view))}}]),t}(r.a.Component),R=n(107),T=n.n(R),I=function(e){function t(e){var n;return Object(f.a)(this,t),(n=Object(d.a)(this,Object(b.a)(t).call(this,e))).button={signup:r.a.createElement(h.c,{onClick:function(){return n.confirmRegister()}},"\u0417\u0430\u043f\u0438\u0441\u0430\u0442\u044c\u0441\u044f \u043d\u0430 \u0438\u0433\u0440\u0443"),signed:r.a.createElement(h.c,{onClick:function(){return n.cancelRegister()},level:"secondary"},"\u0412\u044b \u0437\u0430\u043f\u0438\u0441\u0430\u043d\u044b \u043d\u0430 \u0438\u0433\u0440\u0443"),loading:r.a.createElement(h.c,{level:"secondary",style:{paddingLeft:25,paddingRight:25}},r.a.createElement(h.q,{size:"small"}))},n.state={button:n.button.loading,player:{name:n.props.fetchedUser.first_name,nickname:n.props.fetchedUser.nickname?n.props.fetchedUser.nickname:r.a.createElement("div",{onClick:n.props.go,"data-to":"edit"},"\u0423\u043a\u0430\u0437\u0430\u0442\u044c \u0438\u0433\u0440\u043e\u0432\u043e\u0439 \u043d\u0438\u043a"," ",r.a.createElement(T.a,{width:12,height:12,style:{display:"inline-block"}})),sex:n.props.fetchedUser.sex}},n.updateButton=n.updateButton.bind(Object(v.a)(n)),n.register=n.register.bind(Object(v.a)(n)),n.confirmRegister=n.confirmRegister.bind(Object(v.a)(n)),n.cancelRegister=n.cancelRegister.bind(Object(v.a)(n)),n}return Object(k.a)(t,e),Object(m.a)(t,[{key:"confirmRegister",value:function(){var e=this;this.props.setPopout(r.a.createElement(h.a,{actions:[{title:"\u041e\u0442\u043c\u0435\u043d\u0430",autoclose:!0,style:"cancel"},{title:"\u0417\u0430\u043f\u0438\u0441\u0430\u0442\u044c\u0441\u044f",autoclose:!0,action:this.register}],onClose:function(){return e.props.setPopout(null)}},r.a.createElement("h2",null,"\u0412\u044b \u0445\u043e\u0442\u0438\u0442\u0435 \u0437\u0430\u043f\u0438\u0441\u0430\u0442\u044c\u0441\u044f?"),r.a.createElement("p",null,"\u041e\u0442\u043c\u0435\u043d\u0438\u0442\u044c \u0437\u0430\u043f\u0438\u0441\u044c \u043c\u043e\u0436\u043d\u043e \u0431\u0443\u0434\u0435\u0442 \u0442\u043e\u043b\u044c\u043a\u043e \u0447\u0435\u0440\u0435\u0437 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f \u0441\u043e\u043e\u0431\u0449\u0435\u0441\u0442\u0432\u0430.")))}},{key:"cancelRegister",value:function(){var e=this;this.props.setPopout(r.a.createElement(h.a,{actionsLayout:"vertical",actions:[{title:"\u0421\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f \u0441\u043e\u043e\u0431\u0449\u0435\u0441\u0442\u0432\u0430",autoclose:!0,style:"destructive",action:this.register},{title:"\u0417\u0430\u043a\u0440\u044b\u0442\u044c",autoclose:!0,style:"cancel"}],onClose:function(){return e.props.setPopout(null)}},r.a.createElement("h2",null,"\u041e\u0442\u043c\u0435\u043d\u0430 \u0437\u0430\u043f\u0438\u0441\u0438"),r.a.createElement("p",null,"\u0417\u0430\u043f\u0438\u0441\u044c \u043c\u043e\u0436\u043d\u043e \u043e\u0442\u043c\u0435\u043d\u0438\u0442\u044c \u0442\u043e\u043b\u044c\u043a\u043e \u0447\u0435\u0440\u0435\u0437 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f \u0441\u043e\u043e\u0431\u0449\u0435\u0441\u0442\u0432\u0430.")))}},{key:"register",value:function(){var e;return l.a.async((function(t){for(;;)switch(t.prev=t.next){case 0:return this.setState({button:this.button.loading}),t.next=3,l.a.awrap(C.addToGame(this.props.fetchedUser.id));case 3:e=t.sent,this.setState({button:e?this.button.signed:this.button.signup});case 5:case"end":return t.stop()}}),null,this)}},{key:"updateButton",value:function(){var e;return l.a.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,l.a.awrap(C.isPlayerInGame(this.props.fetchedUser.id));case 2:e=t.sent,this.setState({button:e?this.button.signed:this.button.signup});case 4:case"end":return t.stop()}}),null,this)}},{key:"componentDidMount",value:function(){this.updateButton()}},{key:"componentDidUpdate",value:function(){this.updateButton()}},{key:"render",value:function(){return this.props.fetchedUser?r.a.createElement(h.h,null,r.a.createElement(h.d,{photo:this.props.fetchedUser.photo_200,description:this.state.player.name,bottomContent:this.state.button,before:r.a.createElement(h.b,{src:this.props.fetchedUser.photo_200,size:80}),size:"l",style:{fontSize:"1.2em"}},this.state.player.nickname)):null}}]),t}(r.a.Component),A=function(e){function t(e){var n;return Object(f.a)(this,t),(n=Object(d.a)(this,Object(b.a)(t).call(this,e))).state={fetching:!1},n}return Object(k.a)(t,e),Object(m.a)(t,[{key:"render",value:function(){var e=this;return r.a.createElement(h.l,{id:this.props.id},r.a.createElement(h.m,null,"\u041c\u0430\u0444\u0438\u044f | \u0415\u043b\u0430\u0431\u0443\u0433\u0430"),this.props.fetchedUser&&r.a.createElement(h.n,{onRefresh:function(){return e.forceUpdate()},isFetching:this.state.fetching},r.a.createElement(I,{fetchedUser:this.props.fetchedUser,setPopout:this.props.setPopout,go:this.props.go}),r.a.createElement(S,{fetchedUser:this.props.fetchedUser})))}}]),t}(r.a.Component),G=n(108),N=n(109),z=n(55),B=n.n(z),q=n(56),D=n.n(q),J=Object(h.s)(),M=function(e){function t(e){var n;Object(f.a)(this,t);var a=null!==(n=Object(d.a)(this,Object(b.a)(t).call(this,e))).props.fetchedUser.nickname;return n.state={name:n.props.fetchedUser.name,nickname:a?n.props.fetchedUser.nickname:"",sex:n.props.fetchedUser.sex,nickname_class:"default",nickname_text:"\u041d\u0438\u043a \u0434\u043e\u043b\u0436\u0435\u043d \u0441\u043e\u0441\u0442\u043e\u044f\u0442\u044c \u0442\u043e\u043b\u044c\u043a\u043e \u0438\u0437 \u0440\u0443\u0441\u0441\u043a\u0438\u0445 \u0431\u0443\u043a\u0432"},n.onChange=n.onChange.bind(Object(v.a)(n)),n.onSubmit=n.onSubmit.bind(Object(v.a)(n)),n.back=n.back.bind(Object(v.a)(n)),n}return Object(k.a)(t,e),Object(m.a)(t,[{key:"onChange",value:function(e){console.log(e);var t=e.currentTarget,n=t.name,a=t.value;if(this.setState(Object(N.a)({},n,a)),"nickname"===n){var s=""===a||!/([^\u0410-\u042f\u0430-\u044f]+)/i.test(a);if(this.setState({nickname_class:s?"default":"error",nickname_text:s?this.state.nickname_text:"\u041d\u0438\u043a \u0434\u043e\u043b\u0436\u0435\u043d \u0441\u043e\u0441\u0442\u043e\u044f\u0442\u044c \u0442\u043e\u043b\u044c\u043a\u043e \u0438\u0437 \u0440\u0443\u0441\u0441\u043a\u0438\u0445 \u0431\u0443\u043a\u0432"}),clearTimeout(this.TimerID),!s)return}this.setState({nickname_text:r.a.createElement(h.q,{size:"small"})}),this.TimerID=setTimeout(function(){var e=this;C.getPlayerByNickname(a).then((function(t){t=!(!t||a!==e.props.fetchedUser.nickname),e.setState({nickname_class:!1===t?"valid":"error",nickname_text:!1===t?"\u041d\u0438\u043a \u0441\u0432\u043e\u0431\u043e\u0434\u0435\u043d":"\u0418\u0433\u0440\u043e\u043a \u0441 \u0442\u0430\u043a\u0438\u043c \u043d\u0438\u043a\u043e\u043c \u0443\u0436\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u0435\u0442"})}))}.bind(this),750)}},{key:"onSubmit",value:function(e){var t=this,n=Object(G.a)({},e);return""!==this.state.name&&((""===this.state.nickname||"valid"===this.state.nickname_class||this.state.nickname===this.props.fetchedUser.nickname)&&void C.updatePlayer(this.props.fetchedUser.id,{nickname:this.state.nickname,name:this.state.name,sex:this.state.sex}).then((function(e){!0===e?t.props.go(n):console.warn("Cant save nickname")})))}},{key:"back",value:function(e){this.props.go(e)}},{key:"render",value:function(){var e=this;return r.a.createElement(h.l,{id:this.props.id},r.a.createElement(h.m,{left:r.a.createElement(h.i,{onClick:this.back,"data-to":"home"},J===h.j?r.a.createElement(D.a,null):r.a.createElement(B.a,null))},"\u041c\u0430\u0444\u0438\u044f | \u0420\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435"),this.props.fetchedUser&&r.a.createElement(h.f,null,r.a.createElement(h.k,{type:"text",top:"\u0418\u043c\u044f",name:"name",value:this.state.name,onChange:this.onChange}),r.a.createElement(h.g,{top:"\u041a\u0430\u043a \u043a \u0412\u0430\u043c \u043e\u0431\u0440\u0430\u0449\u0430\u0442\u044c\u0441\u044f?"},r.a.createElement(h.o,{name:"sex",defaultChecked:1===this.state.sex},"\u0413\u043e\u0441\u043f\u043e\u0434\u0438\u043d"),r.a.createElement(h.o,{name:"sex",defaultChecked:0===this.state.sex},"\u0413\u043e\u0441\u043f\u043e\u0436\u0430")),r.a.createElement(h.k,{type:"text",top:"\u0418\u0433\u0440\u043e\u0432\u043e\u0439 \u043d\u0438\u043a",name:"nickname",value:this.state.nickname,onChange:this.onChange,status:this.state.nickname_class,bottom:this.state.nickname_text}),r.a.createElement(h.c,{size:"xl",onClick:function(t){return e.onSubmit(t)},"data-to":"home"},"\u0421\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c")))}}]),t}(r.a.Component),K=n(110),V=n.n(K),W=n(57),L=n.n(W),F=n(111),H=n.n(F),X=n(73),Q=n.n(X),Y=(n(245),Object(h.s)()),Z=function(e){var t=new XMLHttpRequest;t.open("POST","https://vkapp.mailpromtrans.ru/api/register"),t.send(JSON.stringify({vk_id:e.id}));var n=!0;200!==t.status&&(n=!1),!1===JSON.parse(t.responseText).ok&&(n=!1);var a=n?r.a.createElement(Q.a,null,"\u0412\u044b \u0437\u0430\u043f\u0438\u0441\u0430\u043d\u044b \u043d\u0430 \u0438\u0433\u0440\u0443!"):r.a.createElement(Q.a,null,"\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u0437\u0430\u043f\u0438\u0441\u0430\u0442\u044c \u043d\u0430 \u0438\u0433\u0440\u0443",r.a.createElement("br",null),"\u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435 \u0437\u0430\u043f\u0438\u0441\u0430\u0442\u044c\u0441\u044f \u0447\u0435\u0440\u0435\u0437 \u043b\u0438\u0447\u043d\u044b\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f \u0433\u0440\u0443\u043f\u043f\u044b");return r.a.createElement(V.a,{id:e.id},r.a.createElement(L.a,{left:r.a.createElement(H.a,{onClick:e.go,"data-to":"home"},Y===h.j?r.a.createElement(D.a,null):r.a.createElement(B.a,null))},r.a.createElement(L.a,null,"\u0420\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u044f \u043d\u0430 \u041c\u0430\u0444\u0438\u044e")),a)},$=function(){var e=Object(a.useState)("home"),t=Object(p.a)(e,2),n=t[0],s=t[1],c=Object(a.useState)(null),i=Object(p.a)(c,2),u=i[0],f=i[1],m=Object(a.useState)(r.a.createElement(h.p,{size:"large"})),d=Object(p.a)(m,2),b=d[0],k=d[1];Object(a.useEffect)((function(){o.a.subscribe((function(e){var t=e.detail,n=t.type,a=t.data;if("VKWebAppUpdateConfig"===n){var r=document.createAttribute("scheme");r.value=a.scheme?a.scheme:"client_light",document.body.attributes.setNamedItem(r)}})),function(){var e,t;l.a.async((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,l.a.awrap(o.a.send("VKWebAppGetUserInfo"));case 2:return e=n.sent,n.next=5,l.a.awrap(C.getPlayer(e.id));case 5:if(!1!==(t=n.sent)){n.next=12;break}return n.next=9,l.a.awrap(C.registerPlayer(e.id));case 9:return n.next=11,l.a.awrap(C.getPlayer(e.id));case 11:t=n.sent;case 12:e=Object.assign(e,t),f(e),k(null);case 15:case"end":return n.stop()}}))}()}),[]);var v=function(e){s(e.currentTarget.dataset.to)};return r.a.createElement(h.r,{activePanel:n,popout:b},r.a.createElement(A,{id:"home",fetchedUser:u,go:v,setPopout:k}),r.a.createElement(M,{id:"edit",fetchedUser:u,go:v,setPopout:k}),r.a.createElement(Z,{id:"register",go:v}))};o.a.send("VKWebAppInit"),c.a.render(r.a.createElement($,null),document.getElementById("root"))}},[[161,1,2]]]);
//# sourceMappingURL=main.2d2b3171.chunk.js.map